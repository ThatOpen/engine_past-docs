"use strict";(self.webpackChunkengine_docs=self.webpackChunkengine_docs||[]).push([[9768],{9918:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var r=t(4848),o=t(8453);const a={},s=void 0,i={id:"Tutorials/Fragments/Fragments/FragmentsModels",title:"FragmentsModels",description:'window.open("https://thatopen.github.io/engine_fragment/examples/FragmentsModels")} >Go Full Screen',source:"@site/docs/Tutorials/Fragments/Fragments/FragmentsModels.mdx",sourceDirName:"Tutorials/Fragments/Fragments",slug:"/Tutorials/Fragments/Fragments/FragmentsModels",permalink:"/engine_past-docs/3.0.x/Tutorials/Fragments/Fragments/FragmentsModels",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Fragments",permalink:"/engine_past-docs/3.0.x/Tutorials/Fragments/"},next:{title:"IfcImporter",permalink:"/engine_past-docs/3.0.x/Tutorials/Fragments/Fragments/IfcImporter"}},l={},d=[{value:"Loading Fragment Models \ud83d\udd3c",id:"loading-fragment-models-",level:2},{value:"\ud83d\udd96 Importing our Libraries",id:"-importing-our-libraries",level:3},{value:"\ud83c\udf0e Setting up a Simple Scene",id:"-setting-up-a-simple-scene",level:3},{value:"\ud83d\udee0\ufe0f Setting Up Fragments",id:"\ufe0f-setting-up-fragments",level:3},{value:"\ud83d\udcc2 Loading Fragments Models",id:"-loading-fragments-models",level:3},{value:"\ud83d\udee1\ufe0f Prevent Memory Leaks",id:"\ufe0f-prevent-memory-leaks",level:3},{value:"\ud83e\udde9 Adding User Interface (optional)",id:"-adding-user-interface-optional",level:3},{value:"\u23f1\ufe0f Measuring the performance (optional)",id:"\ufe0f-measuring-the-performance-optional",level:3},{value:"\ud83c\udf89 Congratulations!",id:"-congratulations",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{style:{position:"relative"},children:[(0,r.jsx)("iframe",{src:"https://thatopen.github.io/engine_fragment/examples/FragmentsModels"}),(0,r.jsx)("button",{class:"full-screen-btn",onClick:()=>window.open("https://thatopen.github.io/engine_fragment/examples/FragmentsModels"),children:"Go Full Screen"})]}),"\n",(0,r.jsx)(n.admonition,{title:"Source",type:"info",children:(0,r.jsxs)(n.p,{children:["Copying and pasting? We've got you covered! You can find the full source code of this tutorial ",(0,r.jsx)(n.a,{href:"https://github.com/ThatOpen/engine_fragment/blob/a3f91db6422f752fd5dc26532d6cf29eb989b677/packages/fragments/src/FragmentsModels/example.ts",children:"here"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"loading-fragment-models-",children:"Loading Fragment Models \ud83d\udd3c"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"Before diving into the world of Fragments, the first step is to load your Fragment Models. This is a crucial step to unlock the full potential of working with Fragments. Let's explore how to do it effectively."}),"\n",(0,r.jsx)(n.h3,{id:"-importing-our-libraries",children:"\ud83d\udd96 Importing our Libraries"}),"\n",(0,r.jsx)(n.p,{children:"First things first, let's install all necessary dependencies to make this example work:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'import * as THREE from "three";\r\nimport * as OBC from "@thatopen/components";\r\nimport * as BUI from "@thatopen/ui";\r\nimport Stats from "stats.js";\r\n// You have to import * as FRAGS from "@thatopen/fragments"\r\nimport * as FRAGS from "..";\n'})}),"\n",(0,r.jsx)(n.h3,{id:"-setting-up-a-simple-scene",children:"\ud83c\udf0e Setting up a Simple Scene"}),"\n",(0,r.jsx)(n.p,{children:"To get started, let's set up a basic ThreeJS scene. This will serve as the foundation for our application and allow us to visualize the 3D models effectively:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const components = new OBC.Components();\r\n\r\nconst worlds = components.get(OBC.Worlds);\r\nconst world = worlds.create<\r\n  OBC.SimpleScene,\r\n  OBC.SimpleCamera,\r\n  OBC.SimpleRenderer\r\n>();\r\n\r\nworld.scene = new OBC.SimpleScene(components);\r\nworld.scene.setup();\r\nworld.scene.three.background = null;\r\n\r\nconst container = document.getElementById("container")!;\r\nworld.renderer = new OBC.SimpleRenderer(components, container);\r\n\r\nworld.camera = new OBC.SimpleCamera(components);\r\nworld.camera.controls.setLookAt(183, 11, -102, 27, -52, -11); // convenient position for the model we will load\r\n\r\ncomponents.init();\r\n\r\nconst grids = components.get(OBC.Grids);\r\ngrids.create(world);\n'})}),"\n",(0,r.jsx)(n.admonition,{title:"Do I need @thatopen/components?",type:"info",children:(0,r.jsx)(n.p,{children:"Not necessarily! While @thatopen/components simplifies the process of setting up a scene, you can always use plain ThreeJS to create your own custom scene setup. It's entirely up to your preference and project requirements! \ud83d\ude09"})}),"\n",(0,r.jsx)(n.h3,{id:"\ufe0f-setting-up-fragments",children:"\ud83d\udee0\ufe0f Setting Up Fragments"}),"\n",(0,r.jsx)(n.p,{children:"Now, let's configure the Fragments library core. This will allow us to load models effortlessly and start manipulating them with ease:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'// You can copy `/node_modules/@thatopen/fragments/dist/Worker/worker.mjs` to your project directory\r\n// and provide the relative path of the worker, or fetch it from github, unpkg, etc.\r\nconst workerUrl =\r\n  "https://thatopen.github.io/engine_fragment/resources/worker.mjs";\r\nconst fetchedWorker = await fetch(workerUrl);\r\nconst workerText = await fetchedWorker.text();\r\nconst workerFile = new File([new Blob([workerText])], "worker.mjs", {\r\n  type: "text/javascript",\r\n});\r\nconst url = URL.createObjectURL(workerFile);\r\nconst fragments = new FRAGS.FragmentsModels(url);\r\nworld.camera.controls.addEventListener("rest", () => fragments.update(true));\r\nworld.camera.controls.addEventListener("update", () => fragments.update());\r\n\r\n// Once a model is available in the list, we can tell what camera to use\r\n// in order to perform the culling and LOD operations.\r\n// Also, we add the model to the 3D scene.\r\nfragments.models.list.onItemSet.add(({ value: model }) => {\r\n  model.useCamera(world.camera.three);\r\n  world.scene.three.add(model.object);\r\n  // At the end, you tell fragments to update so the model can be seen given\r\n  // the initial camera position\r\n  fragments.update(true);\r\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"-loading-fragments-models",children:"\ud83d\udcc2 Loading Fragments Models"}),"\n",(0,r.jsx)(n.p,{children:"With the core setup complete, it's time to load a Fragments model into our scene. Fragments are optimized for fast loading and rendering, making them ideal for large-scale 3D models."}),"\n",(0,r.jsx)(n.admonition,{title:"Where can I find Fragment files?",type:"info",children:(0,r.jsx)(n.p,{children:"You can use the sample Fragment files available in our repository for testing. If you have an IFC model you'd like to convert to Fragments, check out the IfcImporter tutorial for detailed instructions."})}),"\n",(0,r.jsx)(n.p,{children:"To make things more convenient, let's create a helper function that will load the Fragments Model from a given URL:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const loadFragmentFile = async (url: string, id: string) => {\r\n  const file = await fetch(url);\r\n  const buffer = await file.arrayBuffer();\r\n  await fragments.load(buffer, { modelId: id });\r\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:"At any point, you can retrieve the binary data of a loaded model for exporting. This is particularly useful when models are loaded automatically from a remote source, but you want to provide an option to download the data locally for further use:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const getBinaryData = async (id: string) => {\r\n  const model = fragments.models.list.get(id);\r\n  if (!model) return null;\r\n  const buffer = await model.getBuffer(false);\r\n  return { name: model.modelId, buffer };\r\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:"Now that all Fragments Models are loaded with unique IDs, let's create a helper function to retrieve these IDs. This will make it easier to manage models, such as loading, disposing, or performing other operations on them."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const getModelsIds = () => {\r\n  const models = fragments.models.list.values();\r\n  const ids = [...models].map((model) => model.modelId);\r\n  return ids;\r\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\ufe0f-prevent-memory-leaks",children:"\ud83d\udee1\ufe0f Prevent Memory Leaks"}),"\n",(0,r.jsx)(n.p,{children:"Proper memory management is crucial to ensure your application remains performant and stable. While Fragments Models are optimized for efficiency, it's important to dispose of unused models to prevent memory leaks. Here's a utility function to help you manage this effectively:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const disposeModels = async (ids = getModelsIds()) => {\r\n  const promises = [];\r\n  for (const id of ids) promises.push(fragments.disposeModel(id));\r\n  await Promise.all(promises);\r\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"-adding-user-interface-optional",children:"\ud83e\udde9 Adding User Interface (optional)"}),"\n",(0,r.jsxs)(n.p,{children:["We will use the ",(0,r.jsx)(n.code,{children:"@thatopen/ui"})," library to add some simple and cool UI elements to our app. First, we need to call the ",(0,r.jsx)(n.code,{children:"init"})," method of the ",(0,r.jsx)(n.code,{children:"BUI.Manager"})," class to initialize the library:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"BUI.Manager.init();\n"})}),"\n",(0,r.jsx)(n.p,{children:"Now we will add some UI to handle the logic of this tutorial. For more information about the UI library, you can check the specific documentation for it!"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const [panel, updatePanel] = BUI.Component.create<BUI.PanelSection, any>(\r\n  (_) => {\r\n    const ids = getModelsIds();\r\n\r\n    const onLoadModel = async ({ target }: { target: BUI.Button }) => {\r\n      const name = target.getAttribute("data-name");\r\n      if (!name) return;\r\n      const id = `school_${name}`;\r\n      target.loading = true;\r\n      if (ids.includes(id)) {\r\n        await disposeModels([id]);\r\n      } else {\r\n        await loadFragmentFile(\r\n          `https://thatopen.github.io/engine_fragment/resources/frags/${id}.frag`,\r\n          id,\r\n        );\r\n      }\r\n      target.loading = false;\r\n    };\r\n\r\n    const onDisposeModels = () => disposeModels();\r\n\r\n    const onDownloadModel = async ({ target }: { target: BUI.Button }) => {\r\n      const name = target.getAttribute("data-name");\r\n      if (!name) return;\r\n      const id = `school_${name}`;\r\n      target.loading = true;\r\n      const result = await getBinaryData(id);\r\n      if (result) {\r\n        const { name, buffer } = result;\r\n        const a = document.createElement("a");\r\n        const file = new File([buffer], `${name}.frag`);\r\n        a.href = URL.createObjectURL(file);\r\n        a.download = file.name;\r\n        a.click();\r\n        URL.revokeObjectURL(a.href);\r\n      }\r\n      target.loading = false;\r\n    };\r\n\r\n    const arqLoaded = ids.some((id) => id.includes("arq"));\r\n    const strLoaded = ids.some((id) => id.includes("str"));\r\n    const mepLoaded = ids.some((id) => id.includes("mep"));\r\n\r\n    const arqLabel = arqLoaded ? "Remove Architecture" : "Load Architecture";\r\n    const strLabel = strLoaded ? "Remove Structure" : "Load Structure";\r\n    const mepLabel = mepLoaded ? "Remove Systems" : "Load Systems";\r\n\r\n    return BUI.html`\r\n    <bim-panel id="controls-panel" active label="Fragments Models" class="options-menu">\r\n      <bim-panel-section label="Controls">\r\n        <div style="display: flex; gap: 0.25rem">\r\n          <bim-button data-name="arq" label=${arqLabel} @click=${onLoadModel}></bim-button>\r\n          ${arqLoaded ? BUI.html`<bim-button data-name="arq" label="Download" @click=${onDownloadModel}></bim-button>` : null}\r\n        </div>\r\n        <div style="display: flex; gap: 0.25rem">\r\n          <bim-button data-name="str" label=${strLabel} @click=${onLoadModel}></bim-button>\r\n          ${strLoaded ? BUI.html`<bim-button data-name="str" label="Download" @click=${onDownloadModel}></bim-button>` : null}\r\n        </div>\r\n        <div style="display: flex; gap: 0.25rem">\r\n          <bim-button data-name="mep" label=${mepLabel} @click=${onLoadModel}></bim-button>\r\n          ${mepLoaded ? BUI.html`<bim-button data-name="mep" label="Download" @click=${onDownloadModel}></bim-button>` : null}\r\n        </div>\r\n        <bim-button ?disabled=${ids.length === 0} label="Remove All" @click=${onDisposeModels}></bim-button>\r\n      </bim-panel-section>\r\n    </bim-panel>\r\n  `;\r\n  },\r\n  {},\r\n);\r\n\r\nfragments.models.list.onItemSet.add(() => updatePanel());\r\nfragments.models.list.onItemDeleted.add(() => updatePanel());\r\n\r\ndocument.body.append(panel);\n'})}),"\n",(0,r.jsx)(n.p,{children:"And we will make some logic that adds a button to the screen when the user is visiting our app from their phone, allowing to show or hide the menu. Otherwise, the menu would make the app unusable."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const button = BUI.Component.create<BUI.PanelSection>(() => {\r\n  const onClick = () => {\r\n    if (panel.classList.contains("options-menu-visible")) {\r\n      panel.classList.remove("options-menu-visible");\r\n    } else {\r\n      panel.classList.add("options-menu-visible");\r\n    }\r\n  };\r\n\r\n  return BUI.html`\r\n    <bim-button class="phone-menu-toggler" icon="solar:settings-bold"\r\n      @click=${onClick}>\r\n    </bim-button>\r\n  `;\r\n});\r\n\r\ndocument.body.append(button);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\ufe0f-measuring-the-performance-optional",children:"\u23f1\ufe0f Measuring the performance (optional)"}),"\n",(0,r.jsxs)(n.p,{children:["We'll use the ",(0,r.jsx)(n.a,{href:"https://github.com/mrdoob/stats.js",children:"Stats.js"})," to measure the performance of our app. We will add it to the top left corner of the viewport. This way, we'll make sure that the memory consumption and the FPS of our app are under control."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const stats = new Stats();\r\nstats.showPanel(2);\r\ndocument.body.append(stats.dom);\r\nstats.dom.style.left = "0px";\r\nstats.dom.style.zIndex = "unset";\r\nworld.renderer.onBeforeUpdate.add(() => stats.begin());\r\nworld.renderer.onAfterUpdate.add(() => stats.end());\n'})}),"\n",(0,r.jsx)(n.h3,{id:"-congratulations",children:"\ud83c\udf89 Congratulations!"}),"\n",(0,r.jsx)(n.p,{children:"You've successfully learned how to load and manage Fragments Models! \ud83d\ude80\r\nBy following this guide, you've set up a robust foundation for working with 3D models in your application. From loading and disposing of models to adding a user-friendly interface and optimizing performance, you're now equipped to take your project to the next level.\r\nKeep exploring, experimenting, and building amazing things with Fragments! \ud83c\udf1f"})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>i});var r=t(6540);const o={},a=r.createContext(o);function s(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);